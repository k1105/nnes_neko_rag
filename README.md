# ğŸˆâ€ğŸ–‹ RAG Tutorial â€“ å¹æ°´ã¯çŒ«ã§ã‚ã‚‹

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€å¤ç›®æ¾„çŸ³ã€å¹æ°´ã¯çŒ«ã§ã‚ã‚‹ã€ã‚’é¡Œæã«ã—ãŸ **Retrieval-Augmented Generation (RAG)** ã®æœ€å°æ§‹æˆãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã™ã€‚

å°èª­æœ¬æ–‡ã‚’åˆ†å‰²ï¼ˆãƒãƒ£ãƒ³ã‚¯åŒ–ï¼‰ã—ã€ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ **Qdrant** ã¨ **OpenAI API** ã‚’åˆ©ç”¨ã—ã¦ã€æ„å‘³çš„ã«è¿‘ã„æ–‡è„ˆã‚’å‚ç…§ã—ãªãŒã‚‰è³ªå•ã«å›ç­”ã—ã¾ã™ã€‚

---

## ğŸ’» ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
rag-neko/
â”œâ”€â”€ .env
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ main.txt             # å°èª­æœ¬æ–‡ï¼ˆUTF-8ï¼‰
â”‚   â””â”€â”€ chunks.jsonl         # ãƒãƒ£ãƒ³ã‚¯åŒ–å¾Œãƒ‡ãƒ¼ã‚¿ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰
â”œâ”€â”€ qdrant_storage/          # Qdrant ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â””â”€â”€ app/
    â”œâ”€â”€ chunk.py             # ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²
    â”œâ”€â”€ index.py             # ãƒ™ã‚¯ãƒˆãƒ«åŒ– & Qdrant ç™»éŒ²
    â”œâ”€â”€ query.py             # æ¤œç´¢ & ç”Ÿæˆï¼ˆRAG ã‚³ã‚¢ï¼‰
    â””â”€â”€ api.py               # FastAPI ã«ã‚ˆã‚‹ API ã‚µãƒ¼ãƒ
```

---

## âš™ï¸ äº‹å‰æº–å‚™

### 1. å¿…è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

â€»å¿…è¦ã«å¿œã˜ã¦é©å®œä»®æƒ³ç’°å¢ƒã‚’æ§‹ç¯‰

```bash
pip install -r requirements.txt
```

### 2. `.env` ã®ä½œæˆ

```
OPENAI_API_KEY=sk-xxxxxx
EMBED_MODEL=text-embedding-3-small
CHAT_MODEL=gpt-4o-mini
```

---

## ğŸ³ Qdrant ã®èµ·å‹•

```bash
cd app
docker run -p 6333:6333 -p 6334:6334 \
  -v $(pwd)/qdrant_storage:/qdrant/storage \
  qdrant/qdrant
```

ç¢ºèªï¼š

```bash
curl http://localhost:6333/collections
```

---

## ğŸ§© ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®å®Ÿè¡Œ

### â‘  ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²

```bash
cd app
python chunk.py
```

ç”Ÿæˆçµæœï¼š `data/chunks.jsonl`

### â‘¡ ãƒ™ã‚¯ãƒˆãƒ«åŒ– & Qdrant ç™»éŒ²

```bash
python index.py
```

### â‘¢ ã‚¯ã‚¨ãƒª & ç”Ÿæˆ

```bash
python query.py
```

ä¾‹ï¼š

```
Q> å¾è¼©ã¯ã©ã‚“ãªæ€§æ ¼ï¼Ÿ
A> å¾è¼©ã¯è¦³å¯Ÿå¥½ãã§çš®è‚‰å±‹ãªæ€§æ ¼ã‚’ã—ã¦ã„ã‚‹ã€‚
```

### â‘£ API åŒ–ï¼ˆFastAPI ã‚µãƒ¼ãƒï¼‰

```bash
python -m uvicorn app.api:app --reload --port 8000
```

ãƒ–ãƒ©ã‚¦ã‚¶ã§ [http://127.0.0.1:8000/docs](http://127.0.0.1:8000/docs) ã‚’é–‹ãã€‚

---

## ğŸŒ API å‘¼ã³å‡ºã—ä¾‹

### curl

```bash
curl -X POST http://127.0.0.1:8000/query \
     -H "Content-Type: application/json" \
     -d '{"q":"å¾è¼©ã¯ã©ã‚“ãªæ€§æ ¼ï¼Ÿ","max_chapter_allowed":1}'
```

### Python

```python
import requests

res = requests.post(
    "http://127.0.0.1:8000/query",
    json={"q": "å¾è¼©ã¯ã©ã‚“ãªæ€§æ ¼ï¼Ÿ", "max_chapter_allowed": 1}
)
print(res.json()["answer"])
```

---

## ğŸš€ èµ·å‹•é †åºã¾ã¨ã‚

1ï¸âƒ£ **Qdrant èµ·å‹•ï¼ˆDockerï¼‰**

```bash
docker run -p 6333:6333 -p 6334:6334 \
  -v $(pwd)/qdrant_storage:/qdrant/storage \
  qdrant/qdrant
```

2ï¸âƒ£ **FastAPI èµ·å‹•**

```bash
python -m uvicorn app.api:app --reload --port 8000
```

---

## ğŸ§¹ ã‚ˆãã‚ã‚‹ãƒˆãƒ©ãƒ–ãƒ«

| ç—‡çŠ¶                                            | å¯¾å‡¦                                      |
| ----------------------------------------------- | ----------------------------------------- |
| `Cannot connect to Docker daemon`               | Docker Desktop ã‚’èµ·å‹•ã—ã¦å†è©¦è¡Œ           |
| `Unexpected Response: 400 ... invalid point ID` | index.py ã§ UUID ã‚’ä½¿ç”¨                   |
| `ModuleNotFoundError: No module named 'dotenv'` | `pip install python-dotenv`               |
| `.env ãŒèª­ã‚ãªã„`                               | `.env` ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«ç½®ã         |
| Qdrant ã®ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆãŸ                         | `-v` ã®ãƒ‘ã‚¹ãŒç•°ãªã‚‹ã€‚çµ¶å¯¾ãƒ‘ã‚¹æŒ‡å®šã§å†å®Ÿè¡Œ |

---

## ğŸ§  RAG ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
è³ªå• â†’ åŸ‹ã‚è¾¼ã¿ç”Ÿæˆ â†’ Qdrantæ¤œç´¢ â†’ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰ â†’ GPTç”Ÿæˆ â†’ å›ç­”
```

| æ©Ÿèƒ½         | ãƒ•ã‚¡ã‚¤ãƒ«   | å½¹å‰²                                         |
| ------------ | ---------- | -------------------------------------------- |
| ãƒãƒ£ãƒ³ã‚¯åˆ†å‰² | `chunk.py` | æœ¬æ–‡ã‚’æ„å‘³å˜ä½ã§åˆ†å‰²                         |
| ãƒ™ã‚¯ãƒˆãƒ«ç™»éŒ² | `index.py` | ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒ™ã‚¯ãƒˆãƒ«åŒ–ã—ã¦ä¿å­˜                 |
| æ¤œç´¢ & ç”Ÿæˆ  | `query.py` | è³ªå•ã«å¿œã˜ã¦æ¤œç´¢ãƒ»ç”Ÿæˆ                       |
| API ã‚µãƒ¼ãƒ   | `api.py`   | å¤–éƒ¨ã‹ã‚‰å‘¼ã³å‡ºã™ãŸã‚ã® HTTP ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ |

---

## ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

- `max_chapter_allowed` ã§ **ãƒã‚¿ãƒãƒ¬é˜²æ­¢** åˆ¶å¾¡ã‚’å¼·åŒ–
- ä¼šè©±å±¥æ­´ã‚’ä¿æŒã—ã¦ **é€£ç¶šå¯¾è©±å‹** ã«æ‹¡å¼µ
- Next.js ãªã©ã§ **ãƒãƒ£ãƒƒãƒˆ UI** ã‚’æ§‹ç¯‰

---

ğŸ“˜ **ä½œæˆè€…**: Kanata Yamagishi
ğŸ“… **æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-03
